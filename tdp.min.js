/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16-18
https://github.com/fra-iesus/tdp
*/
!function(w){var l=function(m,t,e){var f=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,scrollToErrorEnabled:!0,scrollToErrorOffset:0,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(t){return t.fadeIn(f.options("animationSpeed"))},validationOkHide:function(t){return t.fadeOut(f.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(t){return t.fadeIn(f.options("animationSpeed"))},validationWorkingHide:function(t){return t.fadeOut(f.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(t){return t.join(f.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(t){return t.fadeIn(f.options("animationSpeed")).fadeOut(f.options("animationSpeed")).fadeIn(f.options("animationSpeed")).fadeOut(f.options("animationSpeed")).fadeIn(f.options("animationSpeed"))},validationMessageShow:function(t){return t.fadeIn(f.options("animationSpeed"))},validationMessageHide:function(t){return t.fadeOut(f.options("animationFastSpeed"))},validatorRequestProcessor:function(t,e){return{data:t,params:e}},validatorResponseProcessor:function(t,e,a){return!!t&&t.response},submitMethod:null,submitTimeout:5e3,submitUrl:null,submitLoadingElement:null,beforeSubmit:null,submitElement:'input[type="submit"]',submitHandlers:{success:function(t){},error:function(t){},always:function(){f.options("submitLoadingElement")&&w(f.options("submitLoadingElement")).hide()}},skipOnInput:["validator","min","not","match"],verbose:!1,logger:null},!e||"object"!=typeof e){if(!t||"object"!=typeof t)return console.warn("$.TdpPlugin constructor called without mandatory parameters");e=t,t={}}function d(t){return t.split(" ")[0]}function c(t,e){var a=t.split(" ");return a[0]+='[name="'+e+'"]',a.join(" ")}function k(t,e){var a;return a=t.is(":visible")?t.offset().top:t.parent().offset().top,e=null===e?a:Math.min(e,a)}function h(t,e){var a=t.split(" ");a=a.reverse();var i=e;return w.each(a,function(t,e){i=function(t,e){var a,i=t.indexOf("."),n=t.indexOf("#"),o="";(0<i||0<n)&&(a=0<i&&0<n?Math.min(i,n):0<i?i:n,o=t.substring(a),t=t.substring(0,a));var s=o.split("."),l=w("<"+t+"></"+t+">"),r="",d="";return w.each(s,function(t,e){0<=e.indexOf("#")?r+=e.replace(/^#/,""):d+=e+" "}),r.length&&l.attr("id",r),d.length&&l.attr("class",d.trim()),w(l).html(e)}(e,i).prop("outerHTML")}),w(i)}(t&&"object"==typeof t||(t={}),this._options=w.extend(!0,{},this._defaults,t),this._parameters=w.extend(!0,{},e),this._parameters.element=m,this.validators_to_go=0,this.after_validators=null,this.options=function(t){return t?"string"==typeof t?this._options[t]:w.extend(!0,this._options,t):this._options},this.options("logger")&&w(this.options("logger")).length?this._log=w(this.options("logger")):this._log=null,this.show=function(){return w(this._parameters.element).show(this.options("dialogShowDuration")),this},this.hide=function(){return w(this._parameters.element).hide(this.options("dialogCloseDuration")),this},this.getInput=function(t){if(!this._parameters.values[t])return console.warn('Unknown input "'+t+'"'),"";var e="radio"===this._parameters.values[t].type?":checked":"",a=w(this._parameters.element).find('input[name="'+t+'"]'+e+',textarea[name="'+t+'"],select[name="'+t+'"]').first();return a.length?a:""!==e&&(a=w(this._parameters.element).find('input[name="'+t+'"],textarea[name="'+t+'"],select[name="'+t+'"]').first()).length?a:(console.warn('Element for input "'+t+'" does not exist'),"")},this.getValue=function(t){if("hidden"===this._parameters.values[t].type)return this._parameters.values[t].value;var e=this.getInput(t);return e&&("radio"!==e.attr("type")&&"checkbox"!==e.attr("type")||e.prop("checked"))?e.val():""},this.setValue=function(t,e){var a=this.getInput(t);if(!a.length)return console.warn('Element for input "'+t+'" does not exist'),!1;if("radio"===a.attr("type")||"checkbox"===a.attr("type")){if(!e)return w(this._parameters.element).find('input[name="'+t+'"]').first().prop("checked",!1);w(this._parameters.element).find('input[name="'+t+'"]').filter('[value="'+e+'"]').first().prop("checked",!0)}return this.getInput(t).val(e)},this.showValidationMsg=function(t,e){this._parameters.values[t].validation_element&&(t=this._parameters.values[t].validation_element);var a=w(this._parameters.element).find(d(this.options("validationMessageElement"))+'[name="'+t+'"]').first();if(a){if(e)w(this._parameters.element).find(c(this.options("validationMessageElement"),t)).first().html(e);this.options("validationMessageShow")(a)}},this.hideValidationMsg=function(t){this._parameters.values[t].validation_element&&(t=this._parameters.values[t].validation_element);var e=w(this._parameters.element).find(d(this.options("validationMessageElement"))+'[name="'+t+'"]').first();e&&(this.options("validationMessageHide")(e),w(this._parameters.element).find(c(this.options("validationMessageElement"),t)).first().html(""))},this.showValidationOk=function(t){var e=w(this._parameters.element).find(d(this.options("validationOkElement"))+'[name="'+t+'"]').first();e&&this.options("validationOkShow")(e)},this.hideValidationOk=function(t){var e=w(this._parameters.element).find(d(this.options("validationOkElement"))+'[name="'+t+'"]').first();e&&this.options("validationOkHide")(e)},this.showValidationWorking=function(t){var e=w(this._parameters.element).find(c(this.options("validationWorkingElement"),t)).first();e&&this.options("validationWorkingShow")(e)},this.hideValidationWorking=function(t){var e=w(this._parameters.element).find(c(this.options("validationWorkingElement"),t)).first();e&&this.options("validationWorkingHide")(e)},this.reset=function(){var a=this;Object.keys(this._parameters.values).forEach(function(t){var e=a._parameters.values[t];"hidden"!==e.type&&(e.validated=null,e.partial_error=!1,e.old_value=null,e.in_progress=!1,a.setValue(t,e.value),a.hideValidationMsg(t),a.hideValidationOk(t),e.value&&a.options("prevalidation")&&a.validate(t))}),a.after_validators=null,a.validators_to_go=0},this.resetAfterValidators=function(){f.after_validators=null,f.validators_to_go=0},this.validationCallback=function(t,e){if(t in f._parameters.values){var a=f._parameters.values[t],i=e?"success":"error",n=f.getValue(t);a.validationCallbacks&&"function"==typeof a.validationCallbacks[i]&&a.validationCallbacks[i](n,e,t,f),a.validationCallbacks&&"function"==typeof a.validationCallbacks.always&&a.validationCallbacks.always(n,e,t,f)}else console.warn('Input "'+t+'" is not defined for validation');return e},this.validate=function(t,p,v){if("string"==typeof t&&"hidden"===this._parameters.values[t].type)return this._parameters.values[t].validated=!0;var m=t instanceof jQuery?t:"string"==typeof t?this.getInput(t):w(t);if(m&&m.is("input,textarea,select")){var f=this,c=m.attr("name");if(c in f._parameters.values){var h=f._parameters.values[c],g=f.getValue(c);if("string"==typeof g&&(g=g.trim(),"tel"===h.type&&(g=g.replace(/[ -]/g,""))),null!==h.old_value&&g===h.old_value&&!h.match&&!h.revalidate)return h.validated;h.old_value=p?null:g,h.matches&&(h.validated=null,h.matches.some(function(t){null!==f._parameters.values[t].validated&&f.validate(t,p,v)}));var _=[],b=!1,y=!1;if(p&&(y=!0),"number"==typeof g&&isNaN(g)||null==g||null==g||""==g){if(f.hideValidationOk(c),h.empty&&!h.revalidate)return f.hideValidationMsg(c),h.validated=!0,f.validationCallback(c,!0);if(!h.empty)return f.showValidationMsg(c,h.empty_message?h.empty_message:f.options("errorMessageEmptyInput")),h.validated=!1,f.validationCallback(c,!1)}if(!h.conditions||!h.conditions.length)return h.validated=!0,f.hideValidationMsg(c),f.options("notEmptyAsValidated")&&f.showValidationOk(c),f.validationCallback(c,!0);h.partial_error=!1,h.fulfilled_conditions=[],h.conditions.some(function(i){if(p&&-1<w.inArray(i.type,p)||i.conditioned&&!h.fulfilled_conditions[i.conditioned])return!1;var t,e,a=!0;switch(h.type){case"tel":case"email":case"password":case"text":t=g.length,e=i.value;break;case"date":t=new Date(g),e=new Date(i.value);break;case"integer":(t=parseInt(g,10))!=g&&(t=void 0),e=i.value;break;case"float":(t=parseFloat(g,10))!=g&&(t=void 0),e=i.value;break;case"checkbox":case"radio":case"select":t=g,e=i.value;break;case"hidden":break;default:console.warn('Input "'+c+'" has unknown input type "'+h.type+'"')}switch(null!==f._log&&f._log.append("Evaluating condition '"+i.type+"("+t+", "+e+")'\n"),i.type){case"regular":var n=new RegExp(i.value);a=n.test(g);break;case"not":a=t!==e;break;case"notNaN":a=!("number"==typeof t&&isNaN(t))&&void 0!==t;break;case"valid":a=t==g;break;case"min":a=!("number"==typeof t&&isNaN(t))&&void 0!==t&&e<=t;break;case"max":a=!("number"==typeof t&&isNaN(t))&&void 0!==t&&t<=e;break;case"match":a=g==f.getValue(i.value);break;case"date":case"age":var o,s,l,r=!1;if(w.isArray(i.value)?(o=f.getValue(i.value[0]),s=f.getValue(i.value[1]),l=f.getValue(i.value[2]),o&&s&&l?date=new Date(o,s-1,l):(v?h.empty?(h.validated=!0,a=!0):a=!(y=!0):(a=!0,h.empty?h.validated=!0:y=!0),r=!0)):date=new Date(g),!r)if("[object Date]"!==Object.prototype.toString.call(date)||isNaN(date.getTime()))a=!1;else if("age"===i.type){var d=+date;a=~~((Date.now()-d-864e5)/315576e5)>=i.value[3]}else if(date.getFullYear()==o&&date.getMonth()==s-1&&date.getDate()==l){if(a=!0,w.isArray(i.value)){var u=h.validated;h.validated=!0,i.value.some(function(t){c==t||f._parameters.values[t].validated||f.validate(t,p,v)}),h.validated=u}}else a=!1;break;case"validator":if(g==h.value&&h.prevalidated)a=!0;else if(!h.in_progress){f.hideValidationMsg(c),f.hideValidationOk(c),f.showValidationWorking(c),b=!0,h.validated=!1,f.validators_to_go++,h.in_progress=!0;w.ajax({url:i.value,type:"POST",data:JSON.stringify(f.options("validatorRequestProcessor")(g,i.params)),dataType:"json",timeout:f.options("submitTimeout"),cache:!1,success:function(t){var e=f.options("validatorResponseProcessor")(t,f,c),a=!1;(a="string"==typeof e?f.options("validationMessageProcessor")([e]):!!e&&i.message)||h.partial_error?(h.validated=!1,"string"==typeof a&&f.showValidationMsg(c,a),f.hideValidationOk(c),f.validators_to_go--,f.first_unvalidated=k(m.parent().children("label").length?m.parent().children("label").first():m,f.first_unvalidated),f.after_validators=null,f.validators_to_go||f.options("scrollToErrorEnabled")&&f.first_unvalidated&&w("html, body").animate({scrollTop:f.first_unvalidated+f.options("scrollToErrorOffset")},f.options("scrollToErrorDuration")),f.validationCallback(c,!1)):(h.validated=!0,f.showValidationOk(c),f.validators_to_go--,0===f.validators_to_go&&null!==f.after_validators&&(f.after_validators(),f.after_validators=null),f.validationCallback(c,t))},error:function(t){h.validated=!1,f.validators_to_go--,f.first_unvalidated=k(m.parent().children("label").length?m.parent().children("label").first():m,f.first_unvalidated),f.after_validators=null,a=f.options("validationMessageProcessor")([i.message]),f.showValidationMsg(c,a),f.hideValidationOk(c),f.validators_to_go||f.options("scrollToErrorEnabled")&&f.first_unvalidated&&w("html, body").animate({scrollTop:f.first_unvalidated+f.options("scrollToErrorOffset")},f.options("scrollToErrorDuration"))},async:!0}).always(function(){h.in_progress=!1,f.hideValidationWorking(c)})}break;default:console.warn('Unknown condition type "'+i.type+'"')}if(i.is_condition)a&&(h.fulfilled_conditions[i.is_condition]=!0);else if(!a&&(b||(h.partial_error=!0),_.push(i.message),i.last))return!0;return!1}),y||b?y&&(h.validated=!1):h.validated=0===_.length;var e=f.options("validationMessageProcessor")(_);return e?(f.showValidationMsg(c,e),f.hideValidationOk(c)):(f.hideValidationMsg(c),y||b||h.match&&!f._parameters.values[h.match].validated?f.hideValidationOk(c):f.showValidationOk(c)),f.validationCallback(c,!e)}console.warn('Input "'+c+'" is not defined for validation')}else console.warn('Element "'+t+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(e){var i=f._parameters.values[e];i.validated||(i.validated=null),i.old_value=null;var a=!1,n=!1,o=null,s=null;if(i.conditions&&i.conditions.length&&i.conditions.some(function(t){return"match"===t.type?(a=t.value,f._parameters.values[a].matches||(f._parameters.values[a].matches=[]),f._parameters.values[a].matches.push(e),void(n=!0)):"date"===t.type||"age"===t.type?(n=!0,void(w.isArray(t.value)&&t.value[0]!=e&&(i.validation_element=t.value[0]))):void("min"===t.type?o=t.value:"max"===t.type&&(s=t.value))}),i.match=a,i.revalidate=n,"hidden"!==i.type){if(input_element=m.find('input[name="'+e+'"],textarea[name="'+e+'"],select[name="'+e+'"]'),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(t){var e=[];e="string"==typeof t||"number"==typeof t?[t,t,!1]:[t[0],1<t.length?t[1]:t[0],2<t.length&&!t[2]];var a=h("option",t[1]).attr("value",t[0]);t[2]&&a.attr("disabled"),i.value==e[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var t,l=i.interval[0],r=i.interval[1],d=l<r?1:-1;for(2<i.interval.length&&(d*=i.interval[2]),t=l;t*d<=r*d;t+=d){var u=h("option",t).attr("value",t);i.value==t&&u.attr("selected"),input_element.append(u)}}"radio"===i.type?(i.value&&f.setValue(e,i.value),input_element.on("click",function(){return f.validate(e),!0})):((o||s)&&("number"===input_element.attr("type")&&(o&&input_element.attr("min",o),s&&input_element.attr("max",s)),"text"!==input_element.attr("type")&&"tel"!==input_element.attr("type")||s&&input_element.attr("maxlength",("text"===i.type?s:s.toString().length)+1)),i.value&&f.setValue(e,i.value),"select"===i.type?(input_element.on("input",function(){f.validate(e)}),input_element.on("change",function(){setTimeout(function(){f.validate(e)},100)})):(input_element.on("input",function(){f.validate(e,f.options("skipOnInput"))}),input_element.on("change, blur",function(){setTimeout(function(){f.validate(e)},100)}))),input_element.is("textarea")||input_element.keypress(function(t){if(t&&13==t.which)return w(t.currentTarget).length&&f.validate(w(t.currentTarget).attr("name")),f.submitForm(),!1}),input_element.on("change.autofill DOMAttrModified.autofill keydown.autofill propertychange.autofill",function(t){setTimeout(function(){""!==input_element.val()&&input_element.trigger("input")},0)});var p=input_element;"radio"===i.type&&(p=m.find('input[name="'+e+'"]').last()).length&&p.next('label[for="'+p.attr("id")+'"]').length&&(p=p.next('label[for="'+p.attr("id")+'"]')),!p.length||m.find(c(f.options("validationMessageElement"),e)).length||m.find(c(f.options("validationOkElement"),e)).length||p.after(h(f.options("validationMessageElement"),"").attr("name",e).hide()).after(h(f.options("validationOkElement"),f.options("validationOkText")).attr("name",e).hide());var v=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(t){"validator"!==t.type||(v=!0)}),v&&p.length&&!m.find(c(f.options("validationWorkingElement"),e)).length&&p.after(h(f.options("validationWorkingElement"),"").attr("name",e).hide()),i.validationCallbacks&&Object.keys(i.validationCallbacks).forEach(function(t){var e=i.validationCallbacks[t];"string"==typeof e&&(i.validationCallbacks[t]=new Function("value","result","name","tdp",e))}),f.hideValidationOk(e),f.hideValidationMsg(e),f.hideValidationWorking(e),i.value&&f.options("prevalidation")&&f.validate(e)}}),this.revalidateAll=function(n,o){var s=!0,l=0,r=this;return r.first_unvalidated=null,Object.keys(r._parameters.values).forEach(function(t){var e=r._parameters.values[t];if("hidden"!==e.type&&(!e.validated||e.revalidate)){var a=r.getInput(t);if(a.parent().is(":visible"))if(e.in_progress)s=!1;else{var i=r.validators_to_go;n&&null!==e.validated&&!e.revalidate||e.in_progress||r.validate(t,o,!0),!1===e.validated&&(s=!1,r.validators_to_go===i&&(r.after_validators=null,r.first_unvalidated=k(a.parent().children("label").length?a.parent().children("label").first():a,r.first_unvalidated),setTimeout(function(){r.options("validationMessageFlash")(w(d(r.options("validationMessageElement"))+'[name="'+t+'"]').first())},r.options("validationMessageFlashDelay")*l++)))}}}),!!s||(r.first_unvalidated&&r.options("scrollToErrorEnabled")&&(r.validators_to_go||w("html, body").animate({scrollTop:r.first_unvalidated+r.options("scrollToErrorOffset")},r.options("scrollToErrorDuration"))),!1)},this.getSubmitData=function(){var i=this,n={},o=!1;return Object.keys(i._parameters.values).forEach(function(t){var e,a=!1;"hidden"===i._parameters.values[t].type?(e=i._parameters.values[t].value,a=!0,i._parameters.alwaysSubmit&&(o=!0)):!i._parameters.values[t].match&&i.getInput(t).parent().is(":visible")&&("string"==typeof(e=i.getValue(t))&&(e=e.trim(),"tel"===i._parameters.values[t].type&&(e=e.replace(/[ -]/g,""))),(a=!!i._parameters.alwaysSubmit||e!=i._parameters.values[t].value&&(null!=e&&""!=e||null!=i._parameters.values[t].value&&""!=i._parameters.values[t].value))&&(o=!0)),a&&(i._parameters.values[t].prefix?(i._parameters.values[t].prefix in n||(n[i._parameters.values[t].prefix]={}),n[i._parameters.values[t].prefix][t]=e):n[t]=e)}),{submitData:n,updateNeeded:o}},this.ajaxSubmit=function(){var e=this,t=this.getSubmitData(),a=t&&t.submitData?t.submitData:{};if(!(!t||void 0===t.updateNeeded)&&t.updateNeeded){e.options("beforeSubmit")&&e.options("beforeSubmit")(e),e.options("submitLoadingElement")&&w(e.options("submitLoadingElement")).show();w.ajax({url:e.options("submitUrl"),type:"POST",data:JSON.stringify(a),dataType:"json",timeout:e.options("submitTimeout"),cache:!1,success:function(t){(e._parameters.displayElement||e._parameters.editLink)&&(w(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&w(e._parameters.editLink).show()),"function"==typeof e.options("submitHandlers").success&&e.options("submitHandlers").success(t,e,a)},error:function(t){"function"==typeof e.options("submitHandlers").error&&e.options("submitHandlers").error(t,e,a)},async:!0}).always(function(){"function"==typeof e.options("submitHandlers").always&&e.options("submitHandlers").always(e,a)})}else e._parameters.displayElement&&(w(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&w(e._parameters.editLink).show())},this.submitForm=function(t){return f.after_validators=function(){return null!==f.options("submitMethod")?f.options("submitMethod")(f):f.ajaxSubmit()},null!==t&&"object"==typeof t&&(t.preventDefault(),t.stopPropagation()),!!f.revalidateAll(!1)&&(null!==f.options("submitMethod")?f.options("submitMethod")(f):f.ajaxSubmit())},m.is("form")||m.find("form").length)&&(m.is("form")?m:m.find("form").first()).bind("submit",function(t){return f.submitForm(t),!1});m.find(this.options("submitElement")).on("click",function(t){return f.submitForm(t),!1})};w.fn.tdp=function(t){var a,i="string"==typeof t?t:void 0,n=1<arguments.length?Array.prototype.slice.call(arguments,1)[0]:void 0,o=[],s=[];return i?(this.each(function(){var t=w(this).data("TdpPlugin");o.push(t)}),this.each(function(t){var e=o[t];if(!e)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void s.push(void 0);if("function"==typeof e[i]){var a=e[i].apply(e,n);s.push(a)}else console.warn("Method '"+i+"' not defined in $.TdpPlugin")}),1<s.length?s:s[0]):(a="object"==typeof t?t:void 0,this.each(function(){var t=w(this),e=new l(t,a,n);t.data("TdpPlugin",e)}))}}(jQuery);
