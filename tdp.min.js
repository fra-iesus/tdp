/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16
https://github.com/fra-iesus/tdp
*/
!function(t){var e=function(e,a,i){function n(t){return t.split(" ")[0]}function o(t,e){var a=t.split(" ");return a[0]+='[name="'+e+'"]',a.join(" ")}function s(t,e){var a;return a=t.is(":visible")?t.offset().top:t.parent().offset().top,e=null===e?a:Math.min(e,a)}function r(e,a){function i(e,a){var i=e.indexOf("."),n=e.indexOf("#"),o="";if(i>0||n>0){var s;s=i>0&&n>0?Math.min(i,n):i>0?i:n,o=e.substring(s),e=e.substring(0,s)}var r=o.split("."),l=t("<"+e+"></"+e+">"),d="",u="";return t.each(r,function(t,e){e.indexOf("#")>=0?d+=e.replace(/^#/,""):u+=e+" "}),d.length&&l.attr("id",d),u.length&&l.attr("class",u.trim()),t(l).html(a)}var n=e.split(" ");n=n.reverse();var o=a;return t.each(n,function(t,e){o=i(e,o).prop("outerHTML")}),t(o)}var l=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,scrollToErrorEnabled:!0,scrollToErrorOffset:0,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationOkHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationWorkingHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(t){return t.join(l.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(t){return t.fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed")).fadeOut(l.options("animationSpeed")).fadeIn(l.options("animationSpeed"))},validationMessageShow:function(t){return t.fadeIn(l.options("animationSpeed"))},validationMessageHide:function(t){return t.fadeOut(l.options("animationFastSpeed"))},validatorRequestProcessor:function(t,e){return{data:t,params:e}},validatorResponseProcessor:function(t){return t?t.response:!1},submitMethod:null,submitTimeout:5e3,submitUrl:null,submitLoadingElement:null,beforeSubmit:null,submitElement:'input[type="submit"]',submitHandlers:{success:function(t){},error:function(t){},always:function(){l.options("submitLoadingElement")&&t(l.options("submitLoadingElement")).hide()}},skipOnInput:["validator","min","not","match"],verbose:!1,logger:null},!i||"object"!=typeof i){if(!a||"object"!=typeof a)return console.warn("$.TdpPlugin constructor called without mandatory parameters");i=a,a={}}if(a&&"object"==typeof a||(a={}),this._options=t.extend(!0,{},this._defaults,a),this._parameters=t.extend(!0,{},i),this._parameters.element=e,this.validators_to_go=0,this.after_validators=null,this.options=function(e){return e?"string"==typeof e?this._options[e]:t.extend(!0,this._options,e):this._options},this.options("logger")&&t(this.options("logger")).length?this._log=t(this.options("logger")):this._log=null,this.show=function(){return t(this._parameters.element).show(this.options("dialogShowDuration")),this},this.hide=function(){return t(this._parameters.element).hide(this.options("dialogCloseDuration")),this},this.getInput=function(e){if(!this._parameters.values[e])return console.warn('Unknown input "'+e+'"'),"";var a="radio"===this._parameters.values[e].type?":checked":"",i=t(this._parameters.element).find('input[name="'+e+'"]'+a+',textarea[name="'+e+'"],select[name="'+e+'"]').first();return i.length?i:""!==a&&(i=t(this._parameters.element).find('input[name="'+e+'"],textarea[name="'+e+'"],select[name="'+e+'"]').first(),i.length)?i:(console.warn('Element for input "'+e+'" does not exist'),"")},this.getValue=function(t){if("hidden"===this._parameters.values[t].type)return this._parameters.values[t].value;var e=this.getInput(t);return e&&("radio"!==e.attr("type")&&"checkbox"!==e.attr("type")||e.prop("checked"))?e.val():""},this.setValue=function(e,a){var i=this.getInput(e);if(!i.length)return console.warn('Element for input "'+e+'" does not exist'),!1;if("radio"===i.attr("type")||"checkbox"===i.attr("type")){if(!a)return t(this._parameters.element).find('input[name="'+e+'"]').first().prop("checked",!1);t(this._parameters.element).find('input[name="'+e+'"]').filter('[value="'+a+'"]').first().prop("checked",!0)}return this.getInput(e).val(a)},this.showValidationMsg=function(e,a){this._parameters.values[e].validation_element&&(e=this._parameters.values[e].validation_element);var i=t(this._parameters.element).find(n(this.options("validationMessageElement"))+'[name="'+e+'"]').first();if(i){if(a){var s=t(this._parameters.element).find(o(this.options("validationMessageElement"),e)).first();s.html(a)}this.options("validationMessageShow")(i)}},this.hideValidationMsg=function(e){this._parameters.values[e].validation_element&&(e=this._parameters.values[e].validation_element);var a=t(this._parameters.element).find(n(this.options("validationMessageElement"))+'[name="'+e+'"]').first();if(a){this.options("validationMessageHide")(a);var i=t(this._parameters.element).find(o(this.options("validationMessageElement"),e)).first();i.html("")}},this.showValidationOk=function(e){var a=t(this._parameters.element).find(n(this.options("validationOkElement"))+'[name="'+e+'"]').first();a&&this.options("validationOkShow")(a)},this.hideValidationOk=function(e){var a=t(this._parameters.element).find(n(this.options("validationOkElement"))+'[name="'+e+'"]').first();a&&this.options("validationOkHide")(a)},this.showValidationWorking=function(e){var a=t(this._parameters.element).find(o(this.options("validationWorkingElement"),e)).first();a&&this.options("validationWorkingShow")(a)},this.hideValidationWorking=function(e){var a=t(this._parameters.element).find(o(this.options("validationWorkingElement"),e)).first();a&&this.options("validationWorkingHide")(a)},this.reset=function(){var t=this;Object.keys(this._parameters.values).forEach(function(e){var a=t._parameters.values[e];"hidden"!==a.type&&(a.validated=null,a.partial_error=!1,a.old_value=null,a.in_progress=!1,t.setValue(e,a.value),t.hideValidationMsg(e),t.hideValidationOk(e),a.value&&t.options("prevalidation")&&t.validate(e))}),t.after_validators=null,t.validators_to_go=0},this.resetAfterValidators=function(){l.after_validators=null,l.validators_to_go=0},this.validate=function(e,a,i){if("string"==typeof e&&"hidden"===this._parameters.values[e].type)return this._parameters.values[e].validated=!0,!0;var n=e instanceof jQuery?e:"string"==typeof e?this.getInput(e):t(e);if(n&&n.is("input,textarea,select")){var o=this,r=n.attr("name");if(r in o._parameters.values){var l=o._parameters.values[r],d=o.getValue(r);if("string"==typeof d&&(d=d.trim(),"tel"===l.type&&(d=d.replace(/[ -]/g,""))),null!==l.old_value&&d===l.old_value&&!l.match&&!l.revalidate)return l.validated;a?l.old_value=null:l.old_value=d,l.matches&&(l.validated=null,l.matches.some(function(t){null!==o._parameters.values[t].validated&&o.validate(t,a,i)}));var u=[],p=!1,v=!1;if(a&&(v=!0),"number"==typeof d&&isNaN(d)||void 0==d||null==d||""==d){if(o.hideValidationOk(r),l.empty&&!l.revalidate)return o.hideValidationMsg(r),l.validated=!0,!0;if(!l.empty)return o.showValidationMsg(r,l.empty_message?l.empty_message:o.options("errorMessageEmptyInput")),l.validated=!1,!1}if(!l.conditions||!l.conditions.length)return l.validated=!0,o.hideValidationMsg(r),o.options("notEmptyAsValidated")&&o.showValidationOk(r),!0;l.partial_error=!1,l.conditions.some(function(e){if(a&&t.inArray(e.type,a)>-1)return!1;var m,f,h=!0;switch(l.type){case"tel":case"email":case"password":case"text":m=d.length,f=e.value;break;case"date":m=new Date(d),f=new Date(e.value);break;case"integer":m=parseInt(d,10),m!=d&&(m=void 0),f=e.value;break;case"float":m=parseFloat(d,10),m!=d&&(m=void 0),f=e.value;break;case"checkbox":case"radio":case"select":m=d,f=e.value;break;case"hidden":break;default:console.warn('Input "'+r+'" has unknown input type "'+l.type+'"')}switch(null!==o._log&&o._log.append("Evaluating condition '"+e.type+"("+m+", "+f+")'\n"),e.type){case"regular":var c=new RegExp(e.value);h=c.test(d);break;case"not":h=m!==f;break;case"notNaN":h=!("number"==typeof m&&isNaN(m))&&void 0!==m;break;case"valid":h=m==d;break;case"min":h=!("number"==typeof m&&isNaN(m))&&void 0!==m&&m>=f;break;case"max":h=!("number"==typeof m&&isNaN(m))&&void 0!==m&&f>=m;break;case"match":h=d==o.getValue(e.value);break;case"date":case"age":var g,_,y,b=!1;if(t.isArray(e.value)?(g=o.getValue(e.value[0]),_=o.getValue(e.value[1]),y=o.getValue(e.value[2]),g&&_&&y?date=new Date(g,_-1,y):(i?l.empty?(l.validated=!0,h=!0):(v=!0,h=!1):(h=!0,l.empty?l.validated=!0:v=!0),b=!0)):date=new Date(d),!b)if("[object Date]"!==Object.prototype.toString.call(date)||isNaN(date.getTime()))h=!1;else if("age"===e.type){var k=+date;h=~~((Date.now()-k-864e5)/315576e5)>=e.value[3]}else if(date.getFullYear()==g&&date.getMonth()==_-1&&date.getDate()==y){if(h=!0,t.isArray(e.value)){var w=l.validated;l.validated=!0,e.value.some(function(t){r==t||o._parameters.values[t].validated||o.validate(t,a,i)}),l.validated=w}}else h=!1;break;case"validator":if(d==l.value&&l.prevalidated)h=!0;else if(!l.in_progress){o.hideValidationMsg(r),o.hideValidationOk(r),o.showValidationWorking(r),p=!0,l.validated=!1,o.validators_to_go++,l.in_progress=!0;t.ajax({url:e.value,type:"POST",data:JSON.stringify(o.options("validatorRequestProcessor")(d,e.params)),dataType:"json",timeout:o.options("submitTimeout"),cache:!1,success:function(a){var i=o.options("validatorResponseProcessor")(a),d=!1;d="string"==typeof i?o.options("validationMessageProcessor")([i]):i?e.message:!1,d||l.partial_error?(l.validated=!1,"string"==typeof d&&o.showValidationMsg(r,d),o.hideValidationOk(r),o.validators_to_go--,o.first_unvalidated=s(n.parent().children("label").length?n.parent().children("label").first():n,o.first_unvalidated),o.after_validators=null,o.validators_to_go||o.options("scrollToErrorEnabled")&&o.first_unvalidated&&t("html, body").animate({scrollTop:o.first_unvalidated+o.options("scrollToErrorOffset")},o.options("scrollToErrorDuration"))):(l.validated=!0,o.showValidationOk(r),o.validators_to_go--,0===o.validators_to_go&&null!==o.after_validators&&(o.after_validators(),o.after_validators=null))},error:function(a){l.validated=!1,o.validators_to_go--,o.first_unvalidated=s(n.parent().children("label").length?n.parent().children("label").first():n,o.first_unvalidated),o.after_validators=null,h=o.options("validationMessageProcessor")([e.message]),o.showValidationMsg(r,h),o.hideValidationOk(r),o.validators_to_go||o.options("scrollToErrorEnabled")&&o.first_unvalidated&&t("html, body").animate({scrollTop:o.first_unvalidated+o.options("scrollToErrorOffset")},o.options("scrollToErrorDuration"))},async:!0}).always(function(){l.in_progress=!1,o.hideValidationWorking(r)})}break;default:console.warn('Unknown condition type "'+e.type+'"')}return!h&&(p||(l.partial_error=!0),u.push(e.message),e.last)?!0:!1}),v||p?v&&(l.validated=!1):l.validated=0===u.length;var m=o.options("validationMessageProcessor")(u);return m?(o.showValidationMsg(r,m),o.hideValidationOk(r)):(o.hideValidationMsg(r),v||p||l.match&&!o._parameters.values[l.match].validated?o.hideValidationOk(r):o.showValidationOk(r)),!m}console.warn('Input "'+r+'" is not defined for validation')}else console.warn('Element "'+e+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var i=l._parameters.values[a];i.validated||(i.validated=null),i.old_value=null;var n=!1,s=!1,d=null,u=null;if(i.conditions&&i.conditions.length&&i.conditions.some(function(e){return"match"===e.type?(n=e.value,l._parameters.values[n].matches||(l._parameters.values[n].matches=[]),l._parameters.values[n].matches.push(a),void(s=!0)):"date"===e.type||"age"===e.type?(s=!0,void(t.isArray(e.value)&&e.value[0]!=a&&(i.validation_element=e.value[0]))):void("min"===e.type?d=e.value:"max"===e.type&&(u=e.value))}),i.match=n,i.revalidate=s,"hidden"!==i.type){if(input_element=e.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]'),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(t){var e=[];e="string"==typeof t||"number"==typeof t?[t,t,!1]:[t[0],t.length>1?t[1]:t[0],t.length>2?!t[2]:!1];var a=r("option",t[1]).attr("value",t[0]);t[2]&&a.attr("disabled"),i.value==e[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var p=i.interval[0],v=i.interval[1],m=v>p?1:-1;i.interval.length>2&&(m*=i.interval[2]);var f;for(f=p;v*m>=f*m;f+=m){var h=r("option",f).attr("value",f);i.value==f&&h.attr("selected"),input_element.append(h)}}"radio"===i.type?(i.value&&l.setValue(a,i.value),input_element.on("click",function(){return l.validate(a),!0})):((d||u)&&("number"===input_element.attr("type")&&(d&&input_element.attr("min",d),u&&input_element.attr("max",u)),("text"===input_element.attr("type")||"tel"===input_element.attr("type"))&&u&&input_element.attr("maxlength",("text"===i.type?u:u.toString().length)+1)),i.value&&l.setValue(a,i.value),"select"===i.type?(input_element.on("input",function(){l.validate(a)}),input_element.on("change",function(){setTimeout(function(){l.validate(a)},100)})):(input_element.on("input",function(){l.validate(a,l.options("skipOnInput"))}),input_element.on("change, blur",function(){setTimeout(function(){l.validate(a)},100)}))),input_element.is("textarea")||input_element.keypress(function(e){return e&&13==e.which?(t(e.currentTarget).length&&l.validate(t(e.currentTarget).attr("name")),l.submitForm(),!1):void 0}),input_element.on("change.autofill DOMAttrModified.autofill keydown.autofill propertychange.autofill",function(t){setTimeout(function(){""!==input_element.val()&&input_element.trigger("input")},0)});var c=input_element;"radio"===i.type&&(c=e.find('input[name="'+a+'"]').last(),c.length&&c.next('label[for="'+c.attr("id")+'"]').length&&(c=c.next('label[for="'+c.attr("id")+'"]'))),!c.length||e.find(o(l.options("validationMessageElement"),a)).length||e.find(o(l.options("validationOkElement"),a)).length||c.after(r(l.options("validationMessageElement"),"").attr("name",a).hide()).after(r(l.options("validationOkElement"),l.options("validationOkText")).attr("name",a).hide());var g=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(t){return"validator"===t.type?void(g=!0):void 0}),g&&c.length&&!e.find(o(l.options("validationWorkingElement"),a)).length&&c.after(r(l.options("validationWorkingElement"),"").attr("name",a).hide()),l.hideValidationOk(a),l.hideValidationMsg(a),l.hideValidationWorking(a),i.value&&l.options("prevalidation")&&l.validate(a)}}),this.revalidateAll=function(e,a){var i=!0,o=0,r=this;return r.first_unvalidated=null,Object.keys(r._parameters.values).forEach(function(l){var d=r._parameters.values[l];if("hidden"!==d.type&&(!d.validated||d.revalidate)){var u=r.getInput(l);if(u.parent().is(":visible"))if(d.in_progress)i=!1;else{var p=r.validators_to_go;e&&null!==d.validated&&!d.revalidate||d.in_progress||r.validate(l,a,!0),d.validated===!1&&(i=!1,r.validators_to_go===p&&(r.after_validators=null,r.first_unvalidated=s(u.parent().children("label").length?u.parent().children("label").first():u,r.first_unvalidated),setTimeout(function(){r.options("validationMessageFlash")(t(n(r.options("validationMessageElement"))+'[name="'+l+'"]').first())},r.options("validationMessageFlashDelay")*o++)))}}}),i?!0:(r.first_unvalidated&&r.options("scrollToErrorEnabled")&&(r.validators_to_go||t("html, body").animate({scrollTop:r.first_unvalidated+r.options("scrollToErrorOffset")},r.options("scrollToErrorDuration"))),!1)},this.getSubmitData=function(){var t=this,e={},a=!1;return Object.keys(t._parameters.values).forEach(function(i){var n,o=!1;"hidden"===t._parameters.values[i].type?(n=t._parameters.values[i].value,o=!0,t._parameters.alwaysSubmit&&(a=!0)):!t._parameters.values[i].match&&t.getInput(i).parent().is(":visible")&&(n=t.getValue(i),"string"==typeof n&&(n=n.trim(),"tel"===t._parameters.values[i].type&&(n=n.replace(/[ -]/g,""))),o=t._parameters.alwaysSubmit?!0:n!=t._parameters.values[i].value&&(null!=n&&""!=n||null!=t._parameters.values[i].value&&""!=t._parameters.values[i].value),o&&(a=!0)),o&&(t._parameters.values[i].prefix?(t._parameters.values[i].prefix in e||(e[t._parameters.values[i].prefix]={}),e[t._parameters.values[i].prefix][i]=n):e[i]=n)}),{submitData:e,updateNeeded:a}},this.ajaxSubmit=function(){var e=this,a=this.getSubmitData(),i=a&&a.submitData?a.submitData:{},n=a&&void 0!==a.updateNeeded?a.updateNeeded:!1;if(!n)return void(e._parameters.displayElement&&(t(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&t(e._parameters.editLink).show()));e.options("beforeSubmit")&&e.options("beforeSubmit")(e),e.options("submitLoadingElement")&&t(e.options("submitLoadingElement")).show();t.ajax({url:e.options("submitUrl"),type:"POST",data:JSON.stringify(i),dataType:"json",timeout:e.options("submitTimeout"),cache:!1,success:function(a){(e._parameters.displayElement||e._parameters.editLink)&&(t(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&t(e._parameters.editLink).show()),"function"==typeof e.options("submitHandlers").success&&e.options("submitHandlers").success(a,e,i)},error:function(t){"function"==typeof e.options("submitHandlers").error&&e.options("submitHandlers").error(t,e,i)},async:!0}).always(function(){"function"==typeof e.options("submitHandlers").always&&e.options("submitHandlers").always(e,i)})},this.submitForm=function(t){return l.after_validators=function(){return null!==l.options("submitMethod")?l.options("submitMethod")(l):l.ajaxSubmit()},null!==t&&"object"==typeof t&&(t.preventDefault(),t.stopPropagation()),l.revalidateAll(!1)?null!==l.options("submitMethod")?l.options("submitMethod")(l):l.ajaxSubmit():!1},e.is("form")||e.find("form").length){var d=e.is("form")?e:e.find("form").first();d.bind("submit",function(t){return l.submitForm(t),!1})}e.find(this.options("submitElement")).on("click",function(t){return l.submitForm(t),!1})};t.fn.tdp=function(a){function i(){var e=t(this),a=e.data("TdpPlugin");d.push(a)}function n(t){var e=d[t];if(!e)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void u.push(void 0);if("function"==typeof e[r]){var a=e[r].apply(e,l);u.push(a)}else console.warn("Method '"+r+"' not defined in $.TdpPlugin")}function o(){var a=t(this),i=new e(a,s,l);a.data("TdpPlugin",i)}var s,r="string"==typeof a?a:void 0,l=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,d=[],u=[];return r?(this.each(i),this.each(n),u.length>1?u:u[0]):(s="object"==typeof a?a:void 0,this.each(o))}}(jQuery);
