/*
TDP - Tiny Dialogue Plugin
Alexej Sidorenko, 2k16-18
https://github.com/fra-iesus/tdp
*/
!function(t){var e=function(e,a,i){var n=this;if(this._defaults={animationSpeed:"slow",animationFastSpeed:"fast",errorMessageEmptyInput:"Field is mandatory",scrollToErrorDuration:2e3,scrollToErrorEnabled:!0,scrollToErrorOffset:0,dialogShowDuration:500,dialogCloseDuration:500,dialogAutoclose:!1,validationOkElement:"span.tdp-vld-ok",validationOkText:"âœ“",prevalidation:!0,notEmptyAsValidated:!0,validationOkShow:function(t){return t.fadeIn(n.options("animationSpeed"))},validationOkHide:function(t){return t.fadeOut(n.options("animationFastSpeed"))},validationWorkingElement:"span.tdp-vld-working",validationWorkingShow:function(t){return t.fadeIn(n.options("animationSpeed"))},validationWorkingHide:function(t){return t.fadeOut(n.options("animationFastSpeed"))},validationMessageElement:"span.tdp-vld-msg",validationMessageSeparator:"<br />",validationMessageProcessor:function(t){return t.join(n.options("validationMessageSeparator"))},validationMessageFlashDelay:300,validationMessageFlash:function(t){return t.fadeIn(n.options("animationSpeed")).fadeOut(n.options("animationSpeed")).fadeIn(n.options("animationSpeed")).fadeOut(n.options("animationSpeed")).fadeIn(n.options("animationSpeed"))},validationMessageShow:function(t){return t.fadeIn(n.options("animationSpeed"))},validationMessageHide:function(t){return t.fadeOut(n.options("animationFastSpeed"))},validatorRequestProcessor:function(t,e){return{data:t,params:e}},validatorResponseProcessor:function(t,e,a){return!!t&&t.response},submitMethod:null,submitTimeout:5e3,submitUrl:null,submitLoadingElement:null,beforeSubmit:null,submitElement:'input[type="submit"]',submitHandlers:{success:function(t){},error:function(t){},always:function(){n.options("submitLoadingElement")&&t(n.options("submitLoadingElement")).hide()}},skipOnInput:["validator","min","not","match"],verbose:!1,logger:null},!i||"object"!=typeof i){if(!a||"object"!=typeof a)return console.warn("$.TdpPlugin constructor called without mandatory parameters");i=a,a={}}function o(t){return t.split(" ")[0]}function s(t,e){var a=t.split(" ");return a[0]+='[name="'+e+'"]',a.join(" ")}function l(t,e){var a;return a=t.is(":visible")?t.offset().top:t.parent().offset().top,e=null===e?a:Math.min(e,a)}function r(e,a){var i=e.split(" ");i=i.reverse();var n=a;return t.each(i,function(e,a){n=function(e,a){var i,n=e.indexOf("."),o=e.indexOf("#"),s="";(n>0||o>0)&&(i=n>0&&o>0?Math.min(n,o):n>0?n:o,s=e.substring(i),e=e.substring(0,i));var l=s.split("."),r=t("<"+e+"></"+e+">"),d="",u="";return t.each(l,function(t,e){e.indexOf("#")>=0?d+=e.replace(/^#/,""):u+=e+" "}),d.length&&r.attr("id",d),u.length&&r.attr("class",u.trim()),t(r).html(a)}(a,n).prop("outerHTML")}),t(n)}(a&&"object"==typeof a||(a={}),this._options=t.extend(!0,{},this._defaults,a),this._parameters=t.extend(!0,{},i),this._parameters.element=e,this.validators_to_go=0,this.after_validators=null,this._fully_validated=!1,this.options=function(e){return e?"string"==typeof e?this._options[e]:t.extend(!0,this._options,e):this._options},this.options("logger")&&t(this.options("logger")).length?this._log=t(this.options("logger")):this._log=null,this.show=function(){return t(this._parameters.element).show(this.options("dialogShowDuration")),this},this.hide=function(){return t(this._parameters.element).hide(this.options("dialogCloseDuration")),this},this.getInput=function(e){if(!this._parameters.values[e])return console.warn('Unknown input "'+e+'"'),"";var a="radio"===this._parameters.values[e].type?":checked":"",i=t(this._parameters.element).find('input[name="'+e+'"]'+a+',textarea[name="'+e+'"],select[name="'+e+'"]').first();return i.length?i:""!==a&&(i=t(this._parameters.element).find('input[name="'+e+'"],textarea[name="'+e+'"],select[name="'+e+'"]').first()).length?i:(console.warn('Element for input "'+e+'" does not exist'),"")},this.getValue=function(t){if("hidden"===this._parameters.values[t].type)return this._parameters.values[t].value;var e=this.getInput(t);return e&&("radio"!==e.attr("type")&&"checkbox"!==e.attr("type")||e.prop("checked"))?e.val():""},this.setValue=function(e,a){var i=this.getInput(e);if(!i.length)return console.warn('Element for input "'+e+'" does not exist'),!1;if("radio"===i.attr("type")||"checkbox"===i.attr("type")){if(!a)return t(this._parameters.element).find('input[name="'+e+'"]:checked').first().prop("checked",!1);t(this._parameters.element).find('input[name="'+e+'"]').filter('[value="'+a+'"]').first().prop("checked",!0)}return this.getInput(e).val(a)},this.showValidationMsg=function(e,a){this._parameters.values[e].validation_element&&(e=this._parameters.values[e].validation_element);var i=t(this._parameters.element).find(o(this.options("validationMessageElement"))+'[name="'+e+'"]').first();if(i){if(a)t(this._parameters.element).find(s(this.options("validationMessageElement"),e)).first().html(a);this.options("validationMessageShow")(i)}},this.hideValidationMsg=function(e){this._parameters.values[e].validation_element&&(e=this._parameters.values[e].validation_element);var a=t(this._parameters.element).find(o(this.options("validationMessageElement"))+'[name="'+e+'"]').first();a&&(this.options("validationMessageHide")(a),t(this._parameters.element).find(s(this.options("validationMessageElement"),e)).first().html(""))},this.showValidationOk=function(e){var a=t(this._parameters.element).find(o(this.options("validationOkElement"))+'[name="'+e+'"]').first();a&&this.options("validationOkShow")(a)},this.hideValidationOk=function(e){var a=t(this._parameters.element).find(o(this.options("validationOkElement"))+'[name="'+e+'"]').first();a&&this.options("validationOkHide")(a)},this.showValidationWorking=function(e){var a=t(this._parameters.element).find(s(this.options("validationWorkingElement"),e)).first();a&&this.options("validationWorkingShow")(a)},this.hideValidationWorking=function(e){var a=t(this._parameters.element).find(s(this.options("validationWorkingElement"),e)).first();a&&this.options("validationWorkingHide")(a)},this.reset=function(){var t=this;Object.keys(this._parameters.values).forEach(function(e){var a=t._parameters.values[e];"hidden"!==a.type&&(a.validated=null,a.partial_error=!1,a.old_value=null,a.in_progress=!1,t.setValue(e,a.value),t.hideValidationMsg(e),t.hideValidationOk(e),a.value&&t.options("prevalidation")&&t.validate(e))}),t.after_validators=null,t.validators_to_go=0,t._fully_validated=!1},this.resetAfterValidators=function(){n.after_validators=null,n.validators_to_go=0},this.validationCallback=function(t,e){if(t in n._parameters.values){var a=n._parameters.values[t],i=e?"success":"error",o=n.getValue(t);a.validationCallbacks&&"function"==typeof a.validationCallbacks[i]&&a.validationCallbacks[i](o,e,t,n),a.validationCallbacks&&"function"==typeof a.validationCallbacks.always&&a.validationCallbacks.always(o,e,t,n)}else console.warn('Input "'+t+'" is not defined for validation');return e},this.validate=function(e,a,i){if(this._fully_validated=!1,"string"==typeof e&&"hidden"===this._parameters.values[e].type)return this._parameters.values[e].validated=!0,!0;var n=e instanceof jQuery?e:"string"==typeof e?this.getInput(e):t(e);if(n&&n.is("input,textarea,select")){var o=this,s=n.attr("name");if(s in o._parameters.values){var r=o._parameters.values[s],d=o.getValue(s);if("string"==typeof d&&(d=d.trim(),"tel"===r.type&&(d=d.replace(/[ -]/g,""))),null!==r.old_value&&d===r.old_value&&!r.match&&!r.revalidate)return r.validated;r.old_value=a?null:d,r.matches&&(r.validated=null,r.matches.some(function(t){null!==o._parameters.values[t].validated&&o.validate(t,a,i)}));var u=[],p=!1,v=!1;if(a&&(v=!0),"number"==typeof d&&isNaN(d)||void 0==d||null==d||""==d){if(o.hideValidationOk(s),r.empty&&!r.revalidate)return o.hideValidationMsg(s),r.validated=!0,o.validationCallback(s,!0);if(!r.empty)return o.showValidationMsg(s,r.empty_message?r.empty_message:o.options("errorMessageEmptyInput")),r.validated=!1,o.validationCallback(s,!1)}if(!r.conditions||!r.conditions.length)return r.validated=!0,o.hideValidationMsg(s),o.options("notEmptyAsValidated")&&o.showValidationOk(s),o.validationCallback(s,!0);r.partial_error=!1,r.fulfilled_conditions=[],r.conditions.some(function(e){if(a&&t.inArray(e.type,a)>-1||e.conditioned&&!r.fulfilled_conditions[e.conditioned])return!1;var m,f,c=!0;switch(r.type){case"tel":case"email":case"password":case"text":m=d.length,f=e.value;break;case"date":m=new Date(d),f=new Date(e.value);break;case"integer":(m=parseInt(d,10))!=d&&(m=void 0),f=e.value;break;case"float":(m=parseFloat(d,10))!=d&&(m=void 0),f=e.value;break;case"checkbox":case"radio":case"select":m=d,f=e.value;break;case"hidden":break;default:console.warn('Input "'+s+'" has unknown input type "'+r.type+'"')}switch(null!==o._log&&o._log.append("Evaluating condition '"+e.type+"("+m+", "+f+")'\n"),e.type){case"regular":var h=new RegExp(e.value);c=h.test(d);break;case"not":c=m!==f;break;case"notNaN":c=!("number"==typeof m&&isNaN(m))&&void 0!==m;break;case"valid":c=m==d;break;case"min":c=!("number"==typeof m&&isNaN(m))&&void 0!==m&&m>=f;break;case"max":c=!("number"==typeof m&&isNaN(m))&&void 0!==m&&m<=f;break;case"match":c=d==o.getValue(e.value);break;case"date":case"age":var g,_,b,y=!1;if(t.isArray(e.value)?(g=o.getValue(e.value[0]),_=o.getValue(e.value[1]),b=o.getValue(e.value[2]),g&&_&&b?date=new Date(g,_-1,b):(i?r.empty?(r.validated=!0,c=!0):(v=!0,c=!1):(c=!0,r.empty?r.validated=!0:v=!0),y=!0)):date=new Date(d),!y)if("[object Date]"!==Object.prototype.toString.call(date)||isNaN(date.getTime()))c=!1;else if("age"===e.type){var k=+date;c=~~((Date.now()-k-864e5)/315576e5)>=e.value[3]}else if(date.getFullYear()==g&&date.getMonth()==_-1&&date.getDate()==b){if(c=!0,t.isArray(e.value)){var w=r.validated;r.validated=!0,e.value.some(function(t){s==t||o._parameters.values[t].validated||o.validate(t,a,i)}),r.validated=w}}else c=!1;break;case"validator":if(d==r.value&&r.prevalidated)c=!0;else if(!r.in_progress){o.hideValidationMsg(s),o.hideValidationOk(s),o.showValidationWorking(s),p=!0,r.validated=!1,o.validators_to_go++,r.in_progress=!0;t.ajax({url:e.value,type:"POST",data:JSON.stringify(o.options("validatorRequestProcessor")(d,e.params)),dataType:"json",timeout:o.options("submitTimeout"),cache:!1,success:function(a){var i=o.options("validatorResponseProcessor")(a,o,s),d=!1;(d="string"==typeof i?o.options("validationMessageProcessor")([i]):!!i&&e.message)||r.partial_error?(r.validated=!1,"string"==typeof d&&o.showValidationMsg(s,d),o.hideValidationOk(s),o.validators_to_go--,o.first_unvalidated=l(n.parent().children("label").length?n.parent().children("label").first():n,o.first_unvalidated),o.after_validators=null,o.validators_to_go||o.options("scrollToErrorEnabled")&&o.first_unvalidated&&t("html, body").animate({scrollTop:o.first_unvalidated+o.options("scrollToErrorOffset")},o.options("scrollToErrorDuration")),o.validationCallback(s,!1)):(r.validated=!0,o.showValidationOk(s),o.validators_to_go--,0===o.validators_to_go&&null!==o.after_validators&&(o.after_validators(),o.after_validators=null),o.validationCallback(s,a))},error:function(a){r.validated=!1,o.validators_to_go--,o.first_unvalidated=l(n.parent().children("label").length?n.parent().children("label").first():n,o.first_unvalidated),o.after_validators=null,c=o.options("validationMessageProcessor")([e.message]),o.showValidationMsg(s,c),o.hideValidationOk(s),o.validators_to_go||o.options("scrollToErrorEnabled")&&o.first_unvalidated&&t("html, body").animate({scrollTop:o.first_unvalidated+o.options("scrollToErrorOffset")},o.options("scrollToErrorDuration"))},async:!0}).always(function(){r.in_progress=!1,o.hideValidationWorking(s)})}break;default:console.warn('Unknown condition type "'+e.type+'"')}if(e.is_condition)c&&(r.fulfilled_conditions[e.is_condition]=!0);else if(!c&&(p||(r.partial_error=!0),u.push(e.message),e.last))return!0;return!1}),v||p?v&&(r.validated=!1):r.validated=0===u.length;var m=o.options("validationMessageProcessor")(u);return m?(o.showValidationMsg(s,m),o.hideValidationOk(s)):(o.hideValidationMsg(s),v||p||r.match&&!o._parameters.values[r.match].validated?o.hideValidationOk(s):o.showValidationOk(s)),o.validationCallback(s,!m)}console.warn('Input "'+s+'" is not defined for validation')}else console.warn('Element "'+e+'" is not valid input')},Object.keys(this._parameters.values).forEach(function(a){var i=n._parameters.values[a];i.validated||(i.validated=null),i.old_value=null;var o=!1,l=!1,d=null,u=null;if(i.conditions&&i.conditions.length&&i.conditions.some(function(e){return"match"===e.type?(o=e.value,n._parameters.values[o].matches||(n._parameters.values[o].matches=[]),n._parameters.values[o].matches.push(a),void(l=!0)):"date"===e.type||"age"===e.type?(l=!0,void(t.isArray(e.value)&&e.value[0]!=a&&(i.validation_element=e.value[0]))):void("min"===e.type?d=e.value:"max"===e.type&&(u=e.value))}),i.match=o,i.revalidate=l,"hidden"!==i.type){if(input_element=e.find('input[name="'+a+'"],textarea[name="'+a+'"],select[name="'+a+'"]'),"select"===i.type&&(i.interval||i.values)&&(i.values&&i.values.some(function(t){var e=[];e="string"==typeof t||"number"==typeof t?[t,t,!1]:[t[0],t.length>1?t[1]:t[0],t.length>2&&!t[2]];var a=r("option",t[1]).attr("value",t[0]);t[2]&&a.attr("disabled"),i.value==e[1]&&a.attr("selected"),input_element.append(a)}),i.interval)){var p,v=i.interval[0],m=i.interval[1],f=v<m?1:-1;for(i.interval.length>2&&(f*=i.interval[2]),p=v;p*f<=m*f;p+=f){var c=r("option",p).attr("value",p);i.value==p&&c.attr("selected"),input_element.append(c)}}"radio"===i.type?(i.value&&n.setValue(a,i.value),input_element.on("click",function(){return n.validate(a),!0})):((d||u)&&("number"===input_element.attr("type")&&(d&&input_element.attr("min",d),u&&input_element.attr("max",u)),"text"!==input_element.attr("type")&&"tel"!==input_element.attr("type")||u&&input_element.attr("maxlength",("text"===i.type?u:u.toString().length)+1)),i.value&&n.setValue(a,i.value),"select"===i.type?(input_element.on("input",function(){n.validate(a)}),input_element.on("change",function(){setTimeout(function(){n.validate(a)},100)})):(input_element.on("input",function(){n.validate(a,n.options("skipOnInput"))}),input_element.on("change, blur",function(){setTimeout(function(){n.validate(a)},100)}))),input_element.is("textarea")||input_element.keypress(function(e){if(e&&13==e.which)return t(e.currentTarget).length&&n.validate(t(e.currentTarget).attr("name")),n.submitForm(),!1}),input_element.on("change.autofill DOMAttrModified.autofill keydown.autofill propertychange.autofill",function(t){setTimeout(function(){""!==input_element.val()&&input_element.trigger("input")},0)});var h=input_element;"radio"===i.type&&(h=e.find('input[name="'+a+'"]').last()).length&&h.next('label[for="'+h.attr("id")+'"]').length&&(h=h.next('label[for="'+h.attr("id")+'"]')),!h.length||e.find(s(n.options("validationMessageElement"),a)).length||e.find(s(n.options("validationOkElement"),a)).length||h.after(r(n.options("validationMessageElement"),"").attr("name",a).hide()).after(r(n.options("validationOkElement"),n.options("validationOkText")).attr("name",a).hide());var g=!1;i.conditions&&i.conditions.length&&i.conditions.some(function(t){"validator"!==t.type||(g=!0)}),g&&h.length&&!e.find(s(n.options("validationWorkingElement"),a)).length&&h.after(r(n.options("validationWorkingElement"),"").attr("name",a).hide()),i.validationCallbacks&&Object.keys(i.validationCallbacks).forEach(function(t){var e=i.validationCallbacks[t];"string"==typeof e&&(i.validationCallbacks[t]=new Function("value","result","name","tdp",e))}),n.hideValidationOk(a),n.hideValidationMsg(a),n.hideValidationWorking(a),i.value&&n.options("prevalidation")&&n.validate(a)}}),this.revalidateAll=function(e,a){var i=!0,n=0,s=this;return s.first_unvalidated=null,Object.keys(s._parameters.values).forEach(function(r){var d=s._parameters.values[r];if("hidden"!==d.type&&(!d.validated||d.revalidate)){var u=s.getInput(r);if(u.parent().is(":visible"))if(d.in_progress)i=!1;else{var p=s.validators_to_go;e&&null!==d.validated&&!d.revalidate||d.in_progress||s.validate(r,a,!0),!1===d.validated&&(i=!1,s.validators_to_go===p&&(s.after_validators=null,s.first_unvalidated=l(u.parent().children("label").length?u.parent().children("label").first():u,s.first_unvalidated),setTimeout(function(){s.options("validationMessageFlash")(t(o(s.options("validationMessageElement"))+'[name="'+r+'"]').first())},s.options("validationMessageFlashDelay")*n++)))}}}),i?(s._fully_validated=!0,!0):(s.first_unvalidated&&s.options("scrollToErrorEnabled")&&(s.validators_to_go||t("html, body").animate({scrollTop:s.first_unvalidated+s.options("scrollToErrorOffset")},s.options("scrollToErrorDuration"))),!1)},this.isValidated=function(){return this._fully_validated},this.getSubmitData=function(){var t=this,e={},a=!1;return Object.keys(t._parameters.values).forEach(function(i){var n,o=!1;"hidden"===t._parameters.values[i].type?(n=t._parameters.values[i].value,o=!0,t._parameters.alwaysSubmit&&(a=!0)):!t._parameters.values[i].match&&t.getInput(i).parent().is(":visible")&&("string"==typeof(n=t.getValue(i))&&(n=n.trim(),"tel"===t._parameters.values[i].type&&(n=n.replace(/[ -]/g,""))),(o=!!t._parameters.alwaysSubmit||n!=t._parameters.values[i].value&&(null!=n&&""!=n||null!=t._parameters.values[i].value&&""!=t._parameters.values[i].value))&&(a=!0)),o&&(t._parameters.values[i].prefix?(t._parameters.values[i].prefix in e||(e[t._parameters.values[i].prefix]={}),e[t._parameters.values[i].prefix][i]=n):e[i]=n)}),{submitData:e,updateNeeded:a}},this.ajaxSubmit=function(){var e=this,a=this.getSubmitData(),i=a&&a.submitData?a.submitData:{};if(!(!a||void 0===a.updateNeeded)&&a.updateNeeded){e.options("beforeSubmit")&&e.options("beforeSubmit")(e),e.options("submitLoadingElement")&&t(e.options("submitLoadingElement")).show();t.ajax({url:e.options("submitUrl"),type:"POST",data:JSON.stringify(i),dataType:"json",timeout:e.options("submitTimeout"),cache:!1,success:function(a){(e._parameters.displayElement||e._parameters.editLink)&&(t(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&t(e._parameters.editLink).show()),"function"==typeof e.options("submitHandlers").success&&e.options("submitHandlers").success(a,e,i)},error:function(t){"function"==typeof e.options("submitHandlers").error&&e.options("submitHandlers").error(t,e,i)},async:!0}).always(function(){"function"==typeof e.options("submitHandlers").always&&e.options("submitHandlers").always(e,i)})}else e._parameters.displayElement&&(t(e._parameters.element).hide(e.options("animationFastSpeed")),e._parameters.editLink&&t(e._parameters.editLink).show())},this.submitForm=function(t){return n.after_validators=function(){return null!==n.options("submitMethod")?n.options("submitMethod")(n):n.ajaxSubmit()},null!==t&&"object"==typeof t&&(t.preventDefault(),t.stopPropagation()),!!n.revalidateAll(!1)&&(null!==n.options("submitMethod")?n.options("submitMethod")(n):n.ajaxSubmit())},e.is("form")||e.find("form").length)&&(e.is("form")?e:e.find("form").first()).bind("submit",function(t){return n.submitForm(t),!1});e.find(this.options("submitElement")).on("click",function(t){return n.submitForm(t),!1})};t.fn.tdp=function(a){var i,n="string"==typeof a?a:void 0,o=arguments.length>1?Array.prototype.slice.call(arguments,1)[0]:void 0,s=[],l=[];return n?(this.each(function(){var e=t(this).data("TdpPlugin");s.push(e)}),this.each(function(t){var e=s[t];if(!e)return console.warn("$.TdpPlugin not instantiated yet"),console.info(this),void l.push(void 0);if("function"==typeof e[n]){var a=e[n].apply(e,o);l.push(a)}else console.warn("Method '"+n+"' not defined in $.TdpPlugin")}),l.length>1?l:l[0]):(i="object"==typeof a?a:void 0,this.each(function(){var a=t(this),n=new e(a,i,o);a.data("TdpPlugin",n)}))}}(jQuery);
